(function(g,n){var j=Backbone.View.extend({el:"#posts",initialize:function(){this.collection=new k();this.form_key=g("#tumblr_form_key").attr("content");this.createPosts();n.AutoPaginator.on("after",this.createPosts.bind(this));n.Events.on("posts:load",this.createPosts.bind(this));n.Events.on("post:like",this.likePostById.bind(this));n.Events.on("post:fastreblog",this.fastReblogById.bind(this))},createPosts:function(){_.each(this.$el.find(".post:not(.new_post_buttons):not([data-view-exists])"),this.createPost.bind(this))},createPost:function(r,q){var o=g(r);var p=new d({id:o.attr("data-post-id"),root_id:o.attr("data-root-id"),tumblelog:o.attr("data-tumblelog-name"),tumblelog_key:o.attr("data-tumblelog-key"),reblog_key:o.attr("data-reblog-key"),is_mine:o.hasClass("is_mine"),accepts_answers:o.attr("data-accepts-answers"),following_tumblelog:o.attr("data-following-tumblelog"),reblogged:false,liked:o.find(".post_control.like").hasClass("liked"),form_key:this.form_key,sponsored:o.attr("data-sponsored"),featured_tags:(o.attr("data-featured-tags")||"").split(",")});this.collection.add(p);if(n.isLoggedIn){new c({el:o,model:p})}else{new f({el:o,model:p})}o.attr("data-view-exists",true)},likePostById:function(p,o){o=o||"mouse";this.collection.get(p).like(o)},fastReblogById:function(p,o){this.collection.get(p).fastReblog(o)}});var k=Backbone.Collection.extend({model:d,initialize:function(){this.on("change:liked",this.updateLikeStatus.bind(this));this.on("ignore:success",this.dismiss.bind(this));this.on("unfollow:success",this.dismiss.bind(this))},updateLikeStatus:function(o,p){var q=this.whereBy({liked:!p,root_id:o.get("root_id")});q.invoke("set",{liked:p});if(o.get("liked")){q.invoke("trigger","like:success")}else{q.invoke("trigger","unlike:success")}},dismiss:function(o){this.whereBy({tumblelog:o.get("tumblelog"),sponsored:false}).invoke("dismiss")},whereBy:function(o){return new k(this.where(o))}});var d=Backbone.Model.extend({likePayload:function(o){o=o||"mouse";return{id:this.get("id"),key:this.get("reblog_key"),method:o}},like:function(o){if(this.get("is_mine")){return}this.trigger("like:success",this);if(!this.get("liked")){this.set("liked",true);n.like(this.likePayload(o)).error(this.trigger.bind(this,"like:failure"))}},xhr_request:function(o,r,p){r=_.extend(r,{form_key:this.get("form_key")});var q=g.ajax({data:JSON.stringify(r),type:"POST",url:o});q.done(_.bind(function(s){if(p[200]){p[200].call(this,s)}},this));q.fail(_.bind(function(u,s,t){if(p[u.status]){p[u.status].call(this,u.status)}},this))},unlike:function(){this.set("liked",false);this.trigger("unlike:success",this);n.unlike(this.likePayload()).error(this.trigger.bind(this,"unlike:failure"))},toggleLike:function(){if(this.get("liked")){this.unlike()}else{this.like()}},reblog:function(){if(this.get("reblogged")){return}this.set("reblogged",true);return g.ajax({url:"/fast_reblog",type:"post",data:{reblog_key:this.get("reblog_key"),reblog_post_id:this.get("id"),form_key:g("#tumblr_form_key").attr("content")},success:function(){this.set("reblogged",true)}.bind(this),error:function(){this.set("reblogged",false)}.bind(this)})},fastReblog:function(o){o=o||false;this.trigger("fastreblog:success",o);this.set("reblogged",true);return g.ajax({url:"/fast_reblog",type:"post",data:{reblog_key:this.get("reblog_key"),reblog_post_id:this.get("id"),form_key:g("#tumblr_form_key").attr("content"),queue:o},success:function(){this.set("reblogged",true)}.bind(this),error:function(){this.set("reblogged",false)}.bind(this)})},reply:function(p){var o=n.reply({reply_text:p,post_id:this.get("id"),tumblelog:this.get("tumblelog"),tumblelog_key:this.get("tumblelog_key")});o.success(function(){this.trigger("replied")}.bind(this));return o},destroy:function(){var o={post_id:this.get("id"),channel_id:this.get("tumblelog")};this.xhr_request("/svc/post/delete",o,{200:this.trigger.bind(this,"destroy:success"),401:this.trigger.bind(this,"destroy:failure"),403:this.trigger.bind(this,"destroy:failure"),500:this.trigger.bind(this,"destroy:failure"),})},toggle_spam_tumblelog:function(){var o=g.ajax({url:"/spam/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});o.fail(this.trigger.bind(this,"spam_toggle:failure"));o.success(this.trigger.bind(this,"spam_toggle:success"));return o},toggle_nsfw_tumblelog:function(){var o=g.ajax({url:"/nsfw/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});o.fail(this.trigger.bind(this,"nsfw_toggle:failure"));o.success(this.trigger.bind(this,"nsfw_toggle:success"));return o},toggle_adult_tumblelog:function(){var o=g.ajax({url:"/adult/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});o.fail(this.trigger.bind(this,"adult_toggle:failure"));o.success(this.trigger.bind(this,"adult_toggle:success"));return o},toggle_follow:function(q){var o;var p={tumblelog:this.get("tumblelog"),source:q};if(this.get("following_tumblelog")){this.set("following_tumblelog",false);o=n.unfollow(p);o.done(this.trigger.bind(this,"unfollow:success",this));o.fail(this.trigger.bind(this,"unfollow:failure",this))}else{this.set("following_tumblelog",true);o=n.follow(p);o.done(this.trigger.bind(this,"follow:success",this));o.fail(this.trigger.bind(this,"follow:failure",this))}return o},fan_mail:function(){if(_.isObject(n.FanMail)){var o={href:n.FanMail.make_url_from_tumblelog(this.get("tumblelog"))};n.FanMail.show(o)}},publish:function(){var o=g.ajax({url:"/publish",type:"post",data:{form_key:this.get("form_key"),id:this.get("id")}});o.fail(this.trigger.bind(this,"publish:failure"));o.success(this.trigger.bind(this,"publish:success"))},promote:function(o){var p=g.ajax({url:"/svc/promote",type:"post",data:{tag:o,post_id:this.get("id"),form_key:this.get("form_key"),reblog_key:this.get("reblog_key"),tumblelog_name:this.get("tumblelog")}});p.fail(this.trigger.bind(this,"promote:failure"));p.success(function(q){if(q&&q.status&&q.status=="failure"){this.trigger("promote:failure",q.error)}else{this.trigger.bind(this,"promote:success")}}.bind(this));return p},unpromote:function(o){var p=g.ajax({url:"/svc/unpromote",type:"post",data:{tag_id:o,post_id:this.get("id"),form_key:this.get("form_key"),reblog_key:this.get("reblog_key"),tumblelog_name:this.get("tumblelog")}});p.fail(this.trigger.bind(this,"unpromote:failure"));p.success(this.trigger.bind(this,"unpromote:success"));return p},follow:function(p,o){p=p||this.get("tumblelog");n.follow({tumblelog:p,source:o},{success:g.proxy(function(){n.Events.trigger("follow_tumblelog",{tumblelog:p});this.trigger("follow:success",this)},this),error:g.proxy(function(){this.trigger("follow:failure",this)},this)})},ignore:function(o){o=o||this.get("tumblelog");n.ignore({tumblelog:o}).success(function(){n.Events.trigger("block_tumblelog",{tumblelog:o,can_report:true});this.trigger("ignore:success",this)}.bind(this)).failure(this.trigger.bind(this,"ignore:failure"))},queue:function(){var o=g.ajax({url:"/publish",type:"post",data:{form_key:this.get("form_key"),id:this.get("id"),queue:"queue"}});o.fail(this.trigger.bind(this,"queue:failure"));o.success(this.trigger.bind(this,"queue:success"))},removeSource:function(){this.trigger("remove_source:success",this)},dismiss:function(){this.trigger("dismiss",this)},approve:function(o){var q={form_key:this.get("form_key"),id:this.get("id")};if(o){q.queue=true}var p=g.ajax({url:"/approve_submission/"+this.get("id"),type:"post",dataType:"text",data:q});p.fail(this.trigger.bind(this,"approve:failure"));p.done(this.trigger.bind(this,"approve:success"));return p},deny:function(){var o=g.ajax({url:"/deny_submission",type:"post",data:{pid:this.get("id"),form_key:this.get("form_key")}});o.fail(this.trigger.bind(this,"deny:failure"));o.success(this.trigger.bind(this,"deny:success"));return o},answer:function(p){var o=g.ajax({url:"/answer",type:"post",data:{form_key:this.get("form_key"),post_id:this.get("id"),tumblelog:this.get("tumblelog"),key:this.get("tumblelog_key"),answer_text:p}});o.fail(this.trigger.bind(this,"answer:failure"));o.success(this.trigger.bind(this,"answer:success"));return o}});var i=n.PopoverWithForm.extend({template:"#post_reply_form",initialize:function(o){var p=_.template(g(this.template).html());this.$el.html(p());this.submit_button=this.$("button");this.textarea=this.$("form textarea");this.check_form_state();this.textarea.on("input",_.bind(this.check_form_state,this));this.textarea.on("keyup",_.bind(this.check_form_state,this));_.extend(this.options,{on_hide:this.on_hide,on_show:this.on_show});n.PopoverWithForm.prototype.initialize.apply(this,arguments)},check_form_state:function(){this.submit_button.attr("disabled",this.textarea[0].value.length===0)},on_show:function(){this.position()},on_hide:function(){this.$el.removeClass("active")},submit_form:function(p){p.preventDefault();this.submit_button.attr("disabled",true);this.submit_button.html(this.submit_button.data("label-loading"));var o=this.model.reply(this.textarea.val());o.success(this.on_success.bind(this))},on_success:function(){this.model.set("replied_to",true);this.trigger("success");this.$el.find("button").attr("disabled",false);this.$el.find("textarea").val("");this.hide();this.submit_button.html(this.submit_button.data("label"))}});var e=n.Popover.extend({events:{"click .post_control.delete":"delete","click .post_control.edit":"edit","click .post_control.queue":"queue"},initialize:function(o){_.extend(this.options,{on_show:this.on_show,disable_auto_show:true});n.Popover.prototype.initialize.apply(this,arguments)},"delete":function(o){this.hide();this.$el.removeClass("active")},edit:function(o){this.hide();this.$el.removeClass("active");this.trigger("action:edit")},queue:function(o){this.hide()},on_show:function(){this.position()}});var a=Backbone.View.extend({events:{"click .promote_post a":"promote","change select.promotable_tags":"promote_select"},button_count:5,initialize:function(o){this.render()},render:function(){this.$el.html(this.template())},promote:function(q){var o=g(q.currentTarget);var p=this.model.promote(o.data("tag"));o.addClass("loading");p.always(o.removeClass.bind(o,"loading"));if(n.Popover){n.Popover.hide_all()}},promote_select:function(q){var o=g(q.currentTarget);var p=this.model.promote(o.val());if(n.Popover){n.Popover.hide_all()}},show:function(o){this.$el.show();this.$el.removeClass("hidden")},hide:function(o){this.$el.hide();this.$el.addClass("hidden")},template:function(){var o=_.compact(this.$el.data("promotion-warnings").split(";;"));var p="";p+="<ul>";p+='<li class="popover_sub_header promote_post_header">Promote</li>';if(promotable_tags.length>this.button_count){p+='<div class="promote_select_wrapper">';p+='<select class="popover_menu_item promotable_tags">';p+='<option value="">'+l10n_str.promote_this_post_in+"</option>"}_.each(promotable_tags,function(q,s){var r=(q.promote_diff<0)?"":" ("+q.promote_diff+")";if(q.promote_diff===0){o.push(l10n_str.promote_warning_none.replace("%1$s",q.title))}if(promotable_tags.length>this.button_count){p+='<option value="'+q.tag+'">'+promotable_tags[s].title+r+"</option>"}else{p+='<li class="popover_menu_item promote_post">';p+='<a data-tag="'+q.tag+'" href="#">';p+=promotable_tags[s].title+r;p+="</a>";p+="</li>"}},this);if(promotable_tags.length>this.button_count){p+="</select>";p+="</div>"}if(o.length){p+='<div class="promote_pane_warnings>';_.each(o,function(q){p+='<div class="warning">'+q+"</div>"});p+="</div>"}p+="</ul>";return p}});var b=n.Popover.extend({events:{"click .post_control.unpromote":"unpromote"},initialize:function(o){_.extend(this.options,{on_show:this.on_show,on_hide:this.on_hide,disable_auto_show:true});this.promote_tag_view=new a({el:this.$(".promote_pane"),model:this.model,tags:promotable_tags});this.promote_tag_view.show();n.Popover.prototype.initialize.apply(this,arguments)},on_show:function(){this.position()},on_hide:function(){},promote:function(o){o.preventDefault();if(!(this.promote_tag_view instanceof a)){this.promote_tag_view=new a({el:this.$(".promote_pane"),model:this.model,tags:promotable_tags})}this.promote_tag_view.show()},unpromote:function(q){var o=g(q.currentTarget);var p=this.model.unpromote(o.data("tag"));o.addClass("loading");p.always(o.removeClass.bind(o,"loading"))},});var h=n.Popover.extend({initialize:function(o){_.extend(this.options,{on_show:this.on_show,on_hide:this.on_hide,disable_auto_show:false});this.model.on("nsfw_toggle:success",this.toggle_nsfw_class.bind(this));this.model.on("adult_toggle:success",this.toggle_adult_class.bind(this));this.model.on("spam_toggle:success",this.toggle_spam_class.bind(this));this.model.on("unfollow:success",this.toggle_follow_class.bind(this));this.model.on("follow:success",this.toggle_follow_class.bind(this));this.$el.on("click",".user_menu_toggle_spam",this.toggle_spam.bind(this));this.$el.on("click",".user_menu_toggle_nsfw",this.toggle_nsfw.bind(this));this.$el.on("click",".user_menu_toggle_adult",this.toggle_adult.bind(this));this.$el.on("click",".user_menu_toggle_follow",this.toggle_follow.bind(this));this.$el.on("click",".fan_mail",this.fan_mail.bind(this));n.Popover.prototype.initialize.apply(this,arguments)},on_show:function(){this.position();this.$el.addClass("active")},on_hide:function(){this.$el.removeClass("active")},fan_mail:function(o){if(_.isObject(n.FanMail)){o.preventDefault();this.hide();this.model.fan_mail()}},toggle_spam:function(o){o.preventDefault();this.hide();this.model.toggle_spam_tumblelog()},toggle_nsfw:function(o){o.preventDefault();this.hide();this.model.toggle_nsfw_tumblelog()},toggle_adult:function(o){o.preventDefault();this.hide();this.model.toggle_adult_tumblelog()},toggle_follow:function(o){o.preventDefault();this.hide();this.model.toggle_follow("FOLLOW_SOURCE_DASHBOARD")},toggle_spam_class:function(){this.$(".user_menu_toggle_spam").toggleClass("is_spam")},toggle_nsfw_class:function(){this.$(".user_menu_toggle_nsfw").toggleClass("is_nsfw")},toggle_adult_class:function(){this.$(".user_menu_toggle_adult").toggleClass("is_adult")},toggle_follow_class:function(){this.$(".user_menu_toggle_follow").toggleClass("follow").toggleClass("unfollow")}});var c=Backbone.View.extend({events:{"click .post_control.like:not(.liked)":"like","click .post_control.liked":"unlike","click .post_control.reblog":"reblog","click .post_control.reply":"reply","click .post_control.block":"ignore","click .post_control.publish":"publish","click .post_control.queue":"queue","click .post_control.queue_submission":"queue_submission","click .post_control.delete":"delete","click .post_control.approve":"approve","click .post_control.post_control_menu.creator":"creator_popover","click .post_control.post_control_menu.admin":"admin_popover","click .tumblelog_menu_button":"user_popover","touchend .tumblelog_menu":"user_popover","click .post_control.deny":"deny","click .note .follow":"follow"},initialize:function(){this.controls={};this.controls.like=this.$el.find(".post_control.like");this.controls.reblog=this.$el.find(".post_control.reblog");this.note_count=this.$el.find(".note_count");this.tagsDraggable();if(this.model.get("accepts_answers")){this.setupAnswerForm()}this.like_heart_timeout=null;this.is_click_trigger=false;this.is_reblogged=false;this.model.on("like:success",this.updateLikeStatus.bind(this,true));this.model.on("unlike:success",this.updateLikeStatus.bind(this,false));this.model.on("like:success",this.updateNoteCount.bind(this,true));this.model.on("unlike:success",this.updateNoteCount.bind(this,false));this.model.on("destroy:success",this.destroy.bind(this));this.model.on("dismiss",this.destroy.bind(this));this.model.on("publish:success",this.destroy.bind(this));this.model.on("queue:success",this.destroy.bind(this));this.model.on("unpromote:success",this.destroy.bind(this));this.model.on("promote:failure",this.alert.bind(this));this.model.on("deny:success",this.destroy.bind(this));this.model.on("approve:success",this.destroy.bind(this));this.model.on("answer:success",this.answer.bind(this));this.model.on("fastreblog:success",this.updateReblog.bind(this));this.current_link=true;this.less_link=false;this.more_link=false},edit:function(){if(!n.PostForms){return}event.preventDefault();n.PostForms.edit({type:this.model.get("type"),edit:true,channel_id:this.model.get("tumblelog"),post_id:this.model.get("id"),endpoint:this.model.get("type"),attach_to:this.$el,previous_content_selector:this.$(".post_wrapper"),adjust_offset:true})},"delete":function(p){p.preventDefault();var o=g(p.currentTarget).data("confirm");n.Dialog.confirm(o,this.model.destroy.bind(this.model))},deny:function(p){p.preventDefault();var o=g(p.currentTarget).data("confirm");n.Dialog.confirm(o,this.model.deny.bind(this.model))},approve:function(p){p.preventDefault();var o=g(p.currentTarget).data("confirm");n.Dialog.confirm(o,this.model.approve.bind(this.model,false))},queue:function(p){p.preventDefault();var o=g(p.currentTarget).data("confirm");n.Dialog.confirm(o,this.model.queue.bind(this.model))},queue_submission:function(p){p.preventDefault();var o=g(p.currentTarget).data("confirm");n.Dialog.confirm(o,this.model.approve.bind(this.model,true))},creator_popover:function(o){if(o.target!=o.currentTarget){return}var p=g(o.currentTarget);if(!(this.creatorPopover instanceof e)){this.creatorPopover=new e({model:this.model,el:g(o.target),on_hide:function(){p.removeClass("active")}.bind(this)});this.creatorPopover.on("action:edit",this.edit.bind(this))}p.addClass("active");this.creatorPopover.show()},admin_popover:function(o){if(o.target!=o.currentTarget){return}if(!(this.adminPopover instanceof b)){this.adminPopover=new b({model:this.model,el:g(o.target)})}this.adminPopover.show()},user_popover:function(p){var o=(p.type=="touchend");if(o){p.preventDefault();p.stopPropagation();this.$el.off("click",".tumblelog_menu_button")}if(!(this.userPopover instanceof h)){var q=this.$(p.currentTarget);this.userPopover=new h({model:this.model,el:o?q:q.closest(".tumblelog_menu"),popover:o?q.find(".popover"):q.siblings(".popover")})}this.userPopover.show()},like:function(o){o.preventDefault();this.is_click_trigger=true;this.model.like("mouse")},unlike:function(o){o.preventDefault();this.is_click_trigger=true;this.model.unlike()},reply:function(o){var p=g(o.currentTarget);if(!(this.replyPopover instanceof i)){this.replyPopover=new i({model:this.model,el:p});this.replyPopover.on("success",function(){p.addClass("replied")});this.replyPopover.on("close",function(){p.removeClass("active")})}p.addClass("active");this.replyPopover.show()},publish:function(p){p.preventDefault();var o=g(p.currentTarget).data("confirm");n.Dialog.confirm(o,this.model.publish.bind(this.model))},reblog:function(o){if(o.altKey&&!this.model.reblogged){o.preventDefault();this.is_click_trigger=true;return this.fastReblog(o)}if(this.is_reblogged||!n.PostForms){return}o.preventDefault();this.is_click_trigger=true;n.PostForms.edit({type:this.model.get("type"),channel_id:this.model.get("tumblelog"),reblog_id:this.model.get("id"),endpoint:this.model.get("type"),detached:true,reblog:true,animate_from:this.$el,reblog_key:this.model.get("reblog_key"),previous_content_selector:null})},fastReblog:function(o){o.stopPropagation();o.preventDefault();if(!this.is_reblogged){this.model.fastReblog()}},follow:function(q){q.preventDefault();var p=g(q.currentTarget);var o=p.closest(".note");var r=o.data("tumblelog");o.addClass("is_following");this.model.follow(r)},ignore:function(q){var o=g(q.currentTarget);var p=o.data("confirm");var r=o.data("block");if(r){n.Dialog.confirm(p,this.model.ignore.bind(this.model,r))}else{n.Dialog.confirm(p,this.model.ignore.bind(this.model))}},updateReblog:function(o){this.is_reblogged=true;var q=g('<div class="post_reblog_poof post_poof"></div>'),p=this.controls.reblog;if(o){q.addClass("queue")}if(this.is_click_trigger){p.append(q)}else{if(this.$el.height()>g(window).height()){q.css("top",g(window).height()*0.5)}this.$el.append(q)}this.is_click_trigger=false;setTimeout(function(){q.fadeOut(200,function(){q.remove();p.addClass("reblogged");if(o){p.addClass("queued")}})},300)},updateLikeStatus:function(p){this.controls.like.toggleClass("liked",p);var o=g('<div class="post_animated_heart post_poof"><span class="heart_left"></span><span class="heart_right"></span></div>').toggleClass("unliked",!p);if(this.is_click_trigger){this.controls.like.append(o)}else{if(this.$el.height()>g(window).height()){o.css("top",g(window).height()*0.5)}if(g(".post_animated_heart").length>0){var q=0.2+(Math.random()*0.6);o.css("left",this.$el.width()*q)}this.$el.append(o)}this.is_click_trigger=false;setTimeout(function(){o.fadeOut(200,function(){o.remove()})},300)},updateNoteCount:function(p){var o=this.$(".note_link_current"),q;if(p){q=o.data("more");o.data("less",o.text());this.$el.removeClass("no_notes")}else{q=o.data("less");if(!q.length){this.$el.addClass("no_notes")}}o.text(q);o.attr("title",q)},destroy:function(){this.$el.fadeOut(500,function(){this.unbind();this.$el.parent().remove();n.Events.trigger("DOMEventor:updateRect");this.remove()}.bind(this))},alert:function(o){alert(o)},tagsDraggable:function(){var o=this.$(".post_tags");var p=o.find(".post_tags_inner");if(o.width()<p.width()){o.addClass("draggable no_pop");new m({el:o})}},setupAnswerForm:function(){var o=this.$(".post_answer");if(!(this.answer_form instanceof l)&&o.find(".post_answer_input").length){this.answer_form=new l({model:this.model,el:o,existing_note:this.$el.hasClass("existing_note")})}},answer:function(){this.$el.addClass("existing_note")}});var f=c.extend({initialize:function(){_.extend(c.prototype.events,{"click .post_control.like":"send_to_signup","click .post_control.reblog":"send_to_signup",})},send_to_signup:function(o){if(o){o.preventDefault();o.stopPropagation()}window.top.location.href="/register"}});n.Notes=Backbone.View.extend({initialize:function(){},el:"#posts",loading_notes:false,events:{"click .post_notes_label.note_count":"toggle_notes","click .more_notes_link":"on_more_click"},create_note_views:function(o){o.find(".note:not([data-view-exists])").each(function(q,s){if(g(s).hasClass("reblog")){var r=new n.ReblogNoteView({el:s})}else{var p=new n.NoteView({el:s})}g(s).attr("data-view-exists",true)})},toggle_notes:function(r){r.preventDefault();if(this.loading_notes){return}this.loading_notes=true;var q=g(r.currentTarget);var o=q.closest(".post");var p=o.find(".notes_container");if(p.is(":visible")){this.loading_notes=true;p.slideUp(300,_.bind(function(){n.Events.trigger("DOMEventor:updateRect");this.loading_notes=false;o.removeClass("showing_notes")},this));return}else{if(q.attr("data-notes-loaded")){o.addClass("showing_notes");this.animate_in(p);return}else{o.addClass("loading_notes");this.load_notes(o,{},_.bind(function(t,u,s){o.addClass("showing_notes");o.removeClass("loading_notes");q.attr("data-notes-loaded",true);this.animate_in(p)},this))}}},updateControls:function(p,q){var o=p.find(".more_notes_link");if(q){p.show();o.attr("data-next",q).show()}else{o.attr("data-notes-complete",true);p.hide()}},animate_in:function(o){this.loading_notes=true;o.slideDown(300,_.bind(function(){this.loading_notes=false},this))},on_more_click:function(o){o.preventDefault();this.more_notes(g(o.currentTarget).closest(".post"))},more_notes:function(o){$post=g(o);$link=$post.find(".more_notes_link").hide();$loading=$post.find(".notes_loading").show();this.loading_notes=true;this.load_notes($post,{from_id:$link.attr("data-next")},_.bind(function(q,r,p){$loading.hide();$link.show();this.loading_notes=false},this))},load_notes:function(o,q,r){var p="/dashboard/notes/"+o.attr("data-post-id")+"/"+o.attr("data-tumblelog-key");if(q.from_id){p+="?from_c="+q.from_id}g.ajax(p).done(_.bind(function(x,y,v){var u=o.find(".more_notes_link_container"),s=o.find(".notes"),t=o.find(".more_notes_link"),w=o.find(".notes_loading");t.show();w.hide();this.updateControls(u,v.getResponseHeader("X-next-note"));s.append(g(x).children());this.create_note_views(s);n.Events.trigger("DOMEventor:updateRect");r(x,y,v)},this))}});var m=Backbone.View.extend({initialize:function(){this.dragging=false;this.drag_x=false;this.drag_inner=this.$(".post_tags_inner");this.doc=g(document);this.d=this.getDimensions();this.transform=this.isTransformSupported();this.bindEvents()},bindEvents:function(){this.$el.on("mousedown touchstart touchmove mouseleave mouseup touchend",".post_tags_inner",_.bind(this.dragEvents,this));this.$el.on("click",".post_tag",_.bind(this.handleLinks,this))},getDimensions:function(){var p=this.$el.width();var o=this.drag_inner.width();return{post_width:p,tag_width:o,max_left:0,max_right:((p-o)-10)}},isTransformSupported:function(){var p="transform WebkitTransform MozTransform OTransform msTransform".split(" ");for(var o=0;o<p.length;o++){if(document.createElement("div").style[p[o]]!==undefined){return true}}return false},dragEvents:function(o){switch(o.type){case"mousedown":case"touchstart":this.dragStart(o);break;case"mousemove":case"touchmove":if(this.pointer_down){this.dragMove(o)}break;case"touchend":case"mouseup":this.dragEnd(o);break}},bindDocEvents:function(){this.doc.on("mousemove.tagsDraggable",_.bind(this.dragEvents,this));this.doc.on("mouseup.tagsDraggable",_.bind(this.resetDrag,this))},unbindDocEvents:function(){this.doc.off("mousemove.tagsDraggable");this.doc.off("mouseup.tagsDraggable")},dragStart:function(o){o.preventDefault();if(!this.dragging&&!this.pointer_down){this.pointer_down=true;this.start_x=this.drag_inner.position().left;this.page_x=o.pageX||o.originalEvent.touches[0].pageX;this.bindDocEvents()}},dragMove:function(o){o.preventDefault();o.stopPropagation();this.drag_inner[0].classList.add("dragging");this.dragging=true;o.clientX=o.clientX||o.originalEvent.touches[0].clientX;var p=o.clientX-this.page_x;this.drag_x=p+this.start_x;this.dragSet(this.drag_x)},dragSet:function(o){if(this.transform){this.drag_inner.css("transform","translate("+o+"px, 0)")}else{this.drag_inner.css("left",o)}},handleLinks:function(o){o.preventDefault();o.stopPropagation();if(!this.dragging){window.open(g(o.currentTarget).attr("href"),"_blank")}return false},resetDragPosition:function(){if(this.drag_x>this.d.max_left){this.dragSet(this.d.max_left)}else{if(this.drag_x<this.d.max_right){this.dragSet(this.d.max_right)}}},dragEnd:function(){event.preventDefault();event.stopPropagation();var o=_.bind(this.resetDrag,this);_.delay(o,100)},resetDrag:function(){if(this.dragging||this.pointer_down){this.dragging=false;this.pointer_down=false;this.drag_inner[0].classList.remove("dragging");this.resetDragPosition();this.unbindDocEvents()}}});var l=Backbone.View.extend({events:{"keyup .post_answer_input":"keyup","focus .post_answer_input":"focus","blur  .post_answer_input":"blur","click .post_answer_submit":"submit"},initialize:function(){this.max_length=140;this.answer_input=this.$(".post_answer_input");this.answer_submit=this.$(".post_answer_submit");this.answer_length=this.$(".post_answer_length");this.answer_error_message=this.answer_input.data("error-message");this.existing_note=this.options.existing_note||false;this.answer_text=this.answer_input.val();this.model.on("answer:success",this.answer.bind(this));this.model.on("answer:failure",this.error.bind(this))},keyup:function(o){if(this.existing_note){return false}this.remaining_chars=this.max_length-this.getAnswerLength();if(this.remaining_chars<=0){this.remaining_chars=0}this.answer_length.text(this.remaining_chars);this.answer_text=(this.answer_text!==this.answer_input.val())?this.answer_input.val():this.answer_text;if(o.keyCode==13){o.preventDefault();this.answer_post()}},focus:function(o){if(this.existing_note){return false}this.answer_text=this.answer_input.val();this.$el.addClass("show_submit")},blur:function(o){if(this.getAnswerLength()==0){this.$el.removeClass("show_submit")}},submit:function(o){o.preventDefault();this.answer_post()},answer_post:function(){if(this.getAnswerLength()){this.model.answer(this.getAnswer())}},answer:function(){this.answer_input.blur();this.answer_input.attr("readonly","readonly")},error:function(){n.Dialog.confirm(this.answer_error_message)},getAnswerLength:function(){return this.getAnswer().length},getAnswer:function(){return g.trim(this.answer_input.val())}});n.Posts=j})(jQuery,Tumblr);jQuery(document).ready(function(a){new Tumblr.Posts();if(Tumblr&&Tumblr.Capture){Tumblr.CaptureWebInStream=new Tumblr.Capture.WebInStream()}});