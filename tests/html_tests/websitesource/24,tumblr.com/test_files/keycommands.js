(function(b,a){var c=Backbone.View.extend({el:"body",post_types:["text","photo","quote","link","chat","audio","video"],suspended:false,suspended_exceptions:[],last_key_code:0,mouseout_id:null,events:{keydown:"keydown",keyup:"keyup","click .post_tab_switching .tab_post_type":"click_tab_switch","mouseover .post_tab_switching .tab_post_type":"mouseover_tab_switch","mouseout .post_tab_switching .tab_post_type":"mouseout_tab_switch","click .post_tab_switching":"dismiss_fast_compose"},dismiss_fast_compose:function(d){if(this.post_keying){this.post_keys({toggle:"cancel"})}if(this.tab_switching){this.blog_switcher({toggle:"cancel"})}},click_tab_switch:function(d){this.post_keys({toggle:"stop"})},mouseover_tab_switch:function(d){window.clearTimeout(this.mouseout_id);this.post_keys({toggle:"start",pos:d.currentTarget.attributes["data-index"].value})},mouseout_tab_switch:function(d){this.mouseout_id=window.setTimeout(_.bind(function(){this.post_keys({toggle:"clear"})},this),250)},initialize:function(){this.logged_in=(!b(document.body).hasClass("logged_out"));this.auto_paginate=Tumblr.auto_paginate||false;this.animate_scroll=(Tumblr.animate_scroll!==undefined)?Tumblr.animate_scroll:false;this.scroll_speed=100;this.scroll_offset=7;this.pressed_keys=[];this.current_post=null;if(!Tumblr.enable_dashboard_key_commands){this.suspend()}this.blog_switcher_detection();if(Tumblr.is_xbox){this.animate_scroll=false}},suspend:function(d){this.suspended=true;this.suspended_exceptions=d||[]},resume:function(){this.suspended=false;this.suspended_exceptions=[]},left:function(){if(!this.auto_paginate&&!b("#tumblr_lightbox").length){var d=b("#previous_page_link").attr("href");if(d){location.href=d}}},right:function(){if(!this.auto_paginate&&!b("#tumblr_lightbox").length){var d=b("#next_page_link").attr("href");if(d){location.href=d}}},next:function(d){if(d>(this.current_position+2)&&(d<this.go_to_position||!this.go_to_position)){Tumblr.Popover.hide_all();this.go_to_position=d}},previous:function(d){if(d<(this.current_position-2)&&d>this.go_to_position){Tumblr.Popover.hide_all();this.go_to_position=d}},check_offset:function(d){return(Math.abs(d-this.current_position)<2)},update_post_positions:function(){var d={};b("#posts > .post_container").each(function(){var e=b(this).children(".post"),f=e.attr("id");if(f&&f.indexOf("post_")===0){d[f]=e.offset().top}});this.post_positions=d},get_parse_params:function(d){var e=window.location.pathname.split("/");e.shift();if(e[0]==="tagged"){return"/new/"+d+"?post[tags]="+e[1]}else{return"/new/"+d}},create_new:function(f){if(typeof Tumblr.PostForms=="object"){var d=b("#new_post_label_"+f);var e=d.length?d.attr("href"):this.get_parse_params(f);var g=Tumblr.PostForms.endpoints_to_types[f];var h=Tumblr.PostForms.parse_url_params(e);h.detached=true;Tumblr.PostForms.create({type:g,attach_to:"body",detached:true,mode:"index"},h)}else{document.location.href="/new/"+f;this.suspend()}},like:function(e){var d=b("#"+e);var f=d.find(".post_control.like");var g=d.data("post-id");if(f.length&&g){Tumblr.Events.trigger("post:like",g,"keyboard")}},notes:function(f){var e=b("#"+f);var d=e.find(".post_notes_label");if(d.length<1||d.find(".note_link_current").text()===""){return}var g=d.offset().top-500,h;if(e.find(".post_notes .popover").length>0&&g>e.offset().top){b("html,body").animate({scrollTop:g},200,function(){if(!h){d.trigger("click")}h=true})}else{d.trigger("click")}},reblog:function(d){var e=b("#"+d).find(".post_control.reblog");if(e.length){e.trigger("click")}},elevate:function(){var d=window.pageYOffset||(document.documentElement&&document.documentElement.scrollTop)||document.body.scrollTop;if(d>=1500){b("html, body").stop(true).animate({scrollTop:0},"slow")}},play:function(g,i){var d=b("#"+g),h=d.data("type");if(h=="video"){var f=d.find("iframe.tumblr_video_iframe");var j=d.find(".retro_video_preview");if(f.length>0){f[0].contentWindow.postMessage("toggle","http://"+f.attr("data-origin"));f[0].contentWindow.focus()}else{if(j.length>0){b(".big_play_button",j).click();i.preventDefault()}}}},fast_reblog:function(f,g,e){var h=b("#tumblr_form_key").attr("content"),d=b("#"+f),i=d.find(".post_control.reblog:not(.reblogged)");if(i.length&&this.check_offset(g)){Tumblr.Events.trigger("post:fastreblog",b("#"+f).data("post-id"),e)}},show_plexi:function(){if(Tumblr.Plexi.findByToken("body-plexi")){this.body_plexi=Tumblr.Plexi.findByToken("body-plexi")}if(!this.body_plexi){this.body_plexi=new Tumblr.Plexi({token:"body-plexi"});this.body_plexi.create(document.body,{insertAt:"top",cssClass:"color"})}this.body_plexi.show({transition_class:"fast"})},hide_plexi:function(){if(Tumblr.Plexi.findByToken("body-plexi")){this.body_plexi=Tumblr.Plexi.findByToken("body-plexi")}if(this.body_plexi){this.body_plexi.hide()}},post_keys:function(g){g.toggle=g.toggle||null;g.shift=g.shift||null;g.pos=g.pos||null;if(this.tab_switching){return}var e=b("#post_tab_switching");if(!e.length){return}var f=e.find(".tab_post_type");if(g.toggle=="cancel"){if(!this.creating_new){this.hide_plexi()}this.creating_new=false;e.removeClass("active");clearTimeout(this.show_timeout);clearTimeout(this.fade_timeout);this.cancel_timeout=setTimeout(function(){e.addClass("inactive undimmed")},50);this.post_keying=false;this.post_tab_index=undefined;return}if(g.toggle=="clear"){this.post_tab_index=undefined;f.removeClass("selected loading")}if(g.toggle=="stop"){var d=null;if(this.post_tab_index!==undefined){d=this.post_types[this.post_tab_index]}this.post_tab_index=undefined;if(d){this.creating_new=true;this.create_new(d)}else{this.hide_plexi()}this.post_keys({toggle:"cancel"});return}if(g.toggle=="init"){this.show_plexi();clearTimeout(this.cancel_timeout);clearTimeout(this.fade_timeout);setTimeout(function(){f.removeClass("selected loading");e.removeClass("inactive");e.addClass("active");this.post_keys({toggle:"start"})}.bind(this),50);this.post_keying=true;return}if(g.toggle=="start"){clearTimeout(this.show_timeout);if(g.pos&&(g.pos-1==this.post_tab_index)){return}setTimeout(function(){e.removeClass("undimmed");f.removeClass("selected loading");if(this.post_tab_index===undefined){this.post_tab_index=g.pos?g.pos-1:0}else{this.post_tab_index=g.pos?g.pos-1:(this.post_tab_index+((g.shift)?-1:1));if(this.post_tab_index>=7){this.post_tab_index=0}if(this.post_tab_index<0){this.post_tab_index=6}}e.addClass("active");this.tab_current_post_type=f.eq(this.post_tab_index);this.tab_current_post_type.addClass("selected")}.bind(this),1);return}},blog_switcher:function(h){h.toggle=h.toggle||null;h.shift=h.shift||null;if(this.post_keying){return}this.tab_switching=(h.toggle.length)?true:false;var e=b("#tab_switching");if(!e.length){return}var g=e.find(".tab_blog");g.removeClass("selected loading");if(h.toggle=="cancel"){this.tab_switching=false;this.tab_index=undefined;this.hide_plexi();e.removeClass("active");setTimeout(function(){e.addClass("inactive")},500);return}if(h.toggle=="stop"){this.tab_index=undefined;var d=this.tab_current_blog.find("a.blog_name").attr("href");if(!document.location.href.match(d)){this.tab_current_blog.addClass("loading");var f=new Spinner(Tumblr.spinners.white).spin();this.tab_current_blog.append(f.el);document.location.href=d;this.suspend();b(window).on("keydown",function(){return false})}else{this.blog_switcher({toggle:"cancel"})}return}if(h.toggle=="start"){e.removeClass("inactive");this.show_plexi();setTimeout(_.bind(function(){if(this.tab_index===undefined){this.tab_index=1}else{this.tab_index=this.tab_index+((h.shift)?-1:1);if(this.tab_index>=g.length){this.tab_index=0}if(this.tab_index<0){this.tab_index=g.length-1}}e.addClass("active");this.tab_current_blog=g.eq(this.tab_index);this.tab_current_blog.addClass("selected")},this),50);return}},blog_switcher_detection:function(){if(window.devicePixelRatio){if(escape(navigator.javaEnabled.toString())=="function%20javaEnabled%28%29%20%7B%20%5Bnative%20code%5D%20%7D"){b("html").addClass("tab_switcher_chrome")}else{if(escape(navigator.javaEnabled.toString())!="function%20javaEnabled%28%29%20%7B%20%5Bnative%20code%5D%20%7D"){b("html").addClass("tab_switcher_safari")}}}},match_modifier_keys:function(h,d){if(typeof d=="string"){d=[d]}var f={shift:d.indexOf("shift")>-1,ctrl:d.indexOf("ctrl")>-1,alt:d.indexOf("alt")>-1,meta:d.indexOf("meta")>-1};var g={shift:h.shiftKey,ctrl:h.ctrlKey,alt:h.altKey,meta:h.metaKey};return _.isEqual(f,g)},keydown:function(k){var f=k.charCode?k.charCode:k.keyCode;if(this.suspended&&this.suspended_exceptions.indexOf(f)<0){return}if(this.animating){return}var l=k?k.target:window.event.srcElement;if(b(l).is("input:focus")){return}this.update_post_positions();this.current_position=(window.pageYOffset||(document.documentElement&&document.documentElement.scrollTop)||document.body.scrollTop)+7;this.go_to_position=0;var n=(k.shiftKey||k.ctrlKey||k.altKey||k.metaKey),j;this.pressed_keys[f]=1;if((this.post_keying||this.tab_switching)&&!(k.ctrlKey||k.altKey||k.metaKey)){var h=[74,75,190,76,78,82,32,38,40,33,34,35,36];if(h.indexOf(f)>=0){return false}}if(f==37){this.left()}else{if(f==39){this.right()}else{if(!n){for(j in this.post_positions){var g=j,m=this.post_positions[j],d=b;if(f==74){this.next(m)}if(f==75){this.previous(m)}if(Tumblr.is_xbox&&f==40){this.next(m);k.preventDefault()}if(Tumblr.is_xbox&&f==38){this.previous(m);k.preventDefault()}if(f==190){this.elevate();k.preventDefault();return false}if(this.check_offset(m)){this.current_post=b("#"+g);if(f==76){this.like(g)}if(f==78){this.notes(g)}if(f==82){this.reblog(g)}if(f==32){this.play(g,k);if(this.current_post.length){if(this.current_post.attr("data-type")=="video"&&this.current_post.attr("data-direct-video")){return false}}return true}}}if(this.animate_scroll){if(this.go_to_position&&!this.animating){this.animating=true;b("html,body").stop().animate({scrollTop:this.go_to_position-this.scroll_offset},this.scroll_speed,_.bind(function(){this.animating=false},this))}}else{if(this.go_to_position){window.scrollTo(0,this.go_to_position-this.scroll_offset)}}}}}if(navigator.platform=="MacIntel"){if(f==67&&this.post_keying){this.post_keys({toggle:"start",shift:k.shiftKey})}else{if(f==67&&this.match_modifier_keys(k,"alt")){this.post_keys({toggle:"init",shift:k.shiftKey})}}if(f==13&&this.post_keying){this.post_keys({toggle:"stop"});return false}if(f==27&&this.post_keying){this.post_keys({toggle:"cancel"});return false}if(f==37&&this.post_keying){this.post_keys({toggle:"start",shift:true});return false}if(f==39&&this.post_keying){this.post_keys({toggle:"start"});return false}if(f==9&&this.post_keying){this.post_keys({toggle:"start",shift:k.shiftKey});return false}if(k.altKey&&f==9){this.blog_switcher({toggle:"start",shift:k.shiftKey});return false}if(k.altKey&&f==192){this.blog_switcher({toggle:"start",shift:true});return false}if(k.altKey&&f==27&&this.tab_switching){this.blog_switcher({toggle:"cancel"});return false}if(k.altKey&&f==37&&this.tab_switching){this.blog_switcher({toggle:"start",shift:true});return false}if(k.altKey&&f==39&&this.tab_switching){this.blog_switcher({toggle:"start"});return false}if(k.altKey&&f==82&&this.logged_in){for(j in this.post_positions){this.fast_reblog(j,this.post_positions[j])}return false}if(k.altKey&&f==69&&this.logged_in){for(j in this.post_positions){this.fast_reblog(j,this.post_positions[j],true)}return false}}if(navigator.platform=="Win32"){if(this.pressed_keys[67]&&this.post_keying){this.post_keys({toggle:"start",shift:k.shiftKey})}else{if(this.pressed_keys[90]&&this.pressed_keys[67]){this.post_keys({toggle:"init",shift:k.shiftKey})}}if(this.pressed_keys[13]&&this.post_keying){this.post_keys({toggle:"stop"});return false}if(this.pressed_keys[27]&&this.post_keying){this.post_keys({toggle:"cancel"});return false}if(this.pressed_keys[37]&&this.post_keying){this.post_keys({toggle:"start",shift:true});return false}if(this.pressed_keys[39]&&this.post_keying){this.post_keys({toggle:"start"});return false}if(this.pressed_keys[9]&&this.post_keying){this.post_keys({toggle:"start",shift:k.shiftKey});return false}if(this.pressed_keys[90]&&this.pressed_keys[9]){this.blog_switcher({toggle:"start",shift:k.shiftKey});return false}if(this.pressed_keys[90]&&this.pressed_keys[27]&&this.tab_switching){this.blog_switcher({toggle:"cancel"});return false}if(this.pressed_keys[90]&&this.pressed_keys[192]){this.blog_switcher({toggle:"start",shift:true});return false}if(this.pressed_keys[90]&&this.pressed_keys[37]&&this.tab_switching){this.blog_switcher({toggle:"start",shift:true});return false}if(this.pressed_keys[90]&&this.pressed_keys[39]&&this.tab_switching){this.blog_switcher({toggle:"start"});return false}if(k.shiftKey&&f==82&&this.logged_in){for(j in this.post_positions){this.fast_reblog(j,this.post_positions[j])}return false}if(k.shiftKey&&f==69&&this.logged_in){for(j in this.post_positions){this.fast_reblog(j,this.post_positions[j],true)}return false}}},keyup:function(g){var f=g.charCode?g.charCode:g.keyCode,d=(g.shiftKey||g.ctrlKey||g.altKey||g.metaKey);this.pressed_keys[f]=0;if(navigator.platform=="MacIntel"){if(!g.altKey&&this.tab_switching){this.blog_switcher({toggle:"stop"});return false}}if(navigator.platform=="Win32"){if(!this.pressed_keys[90]&&this.tab_switching){this.blog_switcher({toggle:"stop"});return false}}}});a.KeyCommandsConstructor=c})(jQuery,Tumblr);