/*
 ashiato_multireco.js 1.1.0
 Copyright (c) 2013 Rakuten.Inc
 Date : 2013-04-05 15:50:09
*/
(function(h,f){if(h.jQuery!==f){jQuery.noConflict();var b=jQuery;b.RJS_Helpers&&b().RJS_Slideshow&&(new function(){var a=this;b.extend(a,{settings:{common:{noready:[0,"Int","^[0-1]$"],pagespeed:[100,"Range","0,9999"],opacityspeed:[100,"Range","0,9999"],autoslidetime:[2,"Range","1,99"],autoslideflag:["next","Str","^(next|prev)$"],autoslide:[0,"Int","^[0-1]$"],autoresize:[1,"Int","^[0-1]$"],impvar:["","Str","^[a-zA-Z0-9_]{3,64}$"],impdisp:["","Str","^[a-zA-Z0-9_]{3,64}$"],impnodisp:["","Str","^[a-zA-Z0-9_]{3,64}$"],
verticalmode:[0,"Int","^[1]$"],ajaxtimer:[3,"Range","1,99"],recothreshold:[5,"Int","^[1-9]$"],rankingshuffle:[1,"Int","^[0-1]$"],requestwait:[500,"Range","1,9999"],checkinterval:[100,"Range","1,9999"]},ashiato:{imagesize:["80x80","Str","^[1-9]{1}[0-9]{1,2}x[1-9]{1}[0-9]{1,2}"],omitname:[26,"Range","0,100"],maxitem:[1,"Int","^[1-9]$"],url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"]},reco:{imagesize:["80x80",
"Str","^[1-9]{1}[0-9]{1,2}x[1-9]{1}[0-9]{1,2}"],omitname:[26,"Range","0,100"],maxitem:[3,"Int","^[1-9]$"],url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"]},ranking:{url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],genrelayer:[2,"Int","^[1-9]$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"]}},eobj:{common:{config:b("#ashiatoRecoCommonConfig"),
existItem:b("#ashiatoRecoExistItemDisplay"),altContents:b("#ashiatoRecoAlteredContents"),recoSlider:b("#ashiatoRecoRecoSlider"),loading:b("#ashiatoRecoLoading")},ashiato:{config:b("#ashiatoRecoAshiatoConfig"),prevButton:b("#ashiatoRecoCheckPrevButton"),nextButton:b("#ashiatoRecoCheckNextButton"),proto:b("#prototypeAshiatoRecoAshiatoItem"),itemsDisplay:b("#ashiatoRecoAshiatoItemDisplay")},reco:{config:b("#ashiatoRecoRecoConfig"),prevButton:b("#ashiatoRecoPrevButton"),nextButton:b("#ashiatoRecoNextButton"),
proto:b("#prototypeAshiatoRecoRecoItem"),itemsDisplay:b("#ashiatoRecoRecoItemsDisplay"),altContents:b("#ashiatoRecoRecoAlteredContents")},ranking:{config:b("#ashiatoRecoRankingConfig")}},status:{error:!1,isTimeout:!1},props:{ashiato:{items:[],proto:{html:"",height:0,width:0,identifiers:{itemurl:["",/\#ITEMURL\#/g,""],imageele:['<img src="#ITEMIMGURL#" alt="#ITEMIMGALT#" title="#ITEMIMGTITLE#">',/\#ITEMIMGELE\#/g,""],imageurl:["",/\#ITEMIMGURL\#/g,""],imagealt:["",/\#ITEMIMGALT\#/g,""],imagetitle:["",
/\#ITEMIMGTITLE\#/g,""],itemname:["",/\#ITEMNAME\#/g,""],itemprice:["",/\#ITEMPRICE\#/g,""]}}},reco:{items:[],proto:{html:"",height:0,width:0,identifiers:{itemurl:["",/\#ITEMURL\#/g,""],imageele:['<img src="#ITEMIMGURL#" alt="#ITEMIMGALT#" title="#ITEMIMGTITLE#">',/\#ITEMIMGELE\#/g,""],imageurl:["",/\#ITEMIMGURL\#/g,""],imagealt:["",/\#ITEMIMGALT\#/g,""],imagetitle:["",/\#ITEMIMGTITLE\#/g,""],itemname:["",/\#ITEMNAME\#/g,""],itemprice:["",/\#ITEMPRICE\#/g,""]}}},currentAshiatoIndex:!1,requestPermission:!0,
requestPermissionTimer:null,checkWaitInterval:null,initialized:!1},initialize:function(){a.loadSettings()?1==a.settings.noReady?a.begin():b(document).ready(function(){a.begin()}):a.displayDefaultContents()},loadSettings:function(){a.eobj.ashiato.proto.hide();a.eobj.reco.proto.hide();a.settings.common=b.RJS_Helpers.readAttr(a.eobj.common.config,a.settings.common);a.settings.ashiato=b.RJS_Helpers.readAttr(a.eobj.ashiato.config,a.settings.ashiato);a.settings.reco=b.RJS_Helpers.readAttr(a.eobj.reco.config,
a.settings.reco);a.settings.ranking=b.RJS_Helpers.readAttr(a.eobj.ranking.config,a.settings.ranking);b.extend(a.settings.ashiato,a.settings.common,a.settings.ashiato);b.extend(a.settings.reco,a.settings.common,a.settings.reco);a.settings.ashiato.autoslide=0;a.settings.ashiato.maxitem=1;a.settings.reco.autoslide=0;if(""==a.settings.ashiato.url||512<a.settings.ashiato.url.length||""==a.settings.reco.url||512<a.settings.reco.url.length||""==a.settings.ranking.url||512<a.settings.ranking.url.length||
0===a.eobj.ashiato.proto.length||0===a.eobj.reco.proto.length)return!1;a.settings.common.autoslidetime*=1E3;a.settings.common.ajaxtimer*=1E3;a.eobj.common.config.remove();a.eobj.ashiato.config.remove();a.eobj.reco.config.remove();return!0},displayDefaultContents:function(c){a.eobj.ashiato.proto.remove();a.eobj.reco.proto.remove();a.eobj.common.altContents.show();a.eobj.common.existItem.remove();c&&a.regImpressionCode(c)},displayRecoDefaultContents:function(){a.eobj.common.loading.hide();a.eobj.common.recoSlider.hide();
a.eobj.reco.altContents.show()},displayRecoLoading:function(){a.eobj.reco.altContents.hide();a.eobj.common.altContents.hide();a.eobj.common.recoSlider.hide();a.eobj.common.existItem.show();a.eobj.common.loading.show()},begin:function(){a.getAshiatoData()},getAshiatoData:function(){function c(c){if(a.status.isTimeout)return a.displayDefaultContents(),!1;clearTimeout(d);if(c.code===f||c.num===f)return a.displayDefaultContents(),!1;if("0"!=c.code)return("1"==c.code||"8"==c.code)&&a.regImpressionCode(a.settings.common.impnodisp),
a.displayDefaultContents(),!1;if(1>c.items.length)return a.displayDefaultContents(a.settings.common.impnodisp),!1;for(var b=0;b<c.items.length;b++)/^http:\/\/item.rakuten.co.jp/.test(c.items[b].itemurlfull)&&a.props.ashiato.items.push({itemname:a.editItemname(c.items[b].itemname,a.settings.ashiato.omitname),itemprice:a.editItemprice(c.items[b].itemprice),itemurl:a.editItemurl(c.items[b].itemurlfull,a.settings.ashiato.sid),imageele:"",imageurl:""!=c.items[b].imageurl?a.editImageurl(c.items[b].imageurl,
a.settings.ashiato.imagesize):c.items[b].imageurl64,imagealt:a.editItemname(c.items[b].itemname,a.settings.ashiato.omitname),imagetitle:a.editItemname(c.items[b].itemname,a.settings.ashiato.omitname),mngnumber:c.items[b].mngnumber,shopurl:c.items[b].shopurl,itemid:c.items[b].itemid,shopid:c.items[b].shopid,genreidlist:c.items[b].genreidlist});if(0===a.eobj.ashiato.proto.length)return a.displayDefaultContents(),!1;a.props.ashiato.proto.width=a.eobj.ashiato.proto.outerWidth();a.props.ashiato.proto.height=
a.eobj.ashiato.proto.outerHeight();a.props.ashiato.proto.html=a.eobj.ashiato.proto.html();if(""==a.props.ashiato.proto.html)return a.displayDefaultContents(),!1;a.eobj.ashiato.proto.remove();a.eobj.ashiato.itemsDisplay.RJS_Slideshow(a,{settings:a.settings.ashiato,itemPrototype:a.props.ashiato.proto,eobj:a.eobj.ashiato,items:a.props.ashiato.items,events:{beforeFirstRender:function(a,c){c.eobj.ashiato.itemsDisplay.show()},afterSlide:function(a,c){c.getCachedRecoData(a)||c.getRecoData(a)}}});a.getRecoData(0)}
var d;a.status.isTimeout=!1;try{d=setTimeout(function(){a.status.isTimeout=!0;a.displayDefaultContents()},a.settings.common.ajaxtimer),b.ajax({url:a.settings.ashiato.url,cache:!1,dataType:"jsonp",scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(a){c(a)},error:function(){a.displayDefaultContents()}})}catch(e){return a.displayDefaultContents(),!1}return!0},getCachedRecoData:function(c){if(!1===c||0==a.props.reco.items.length)return!1;var b=a.props.reco.items[c];if(b==f||0==
b.length)return!1;a.displayRecoLoading();a.displayRecoData(c);return!0},getRecoData:function(c){a.displayRecoLoading();if(a.props.requestPermission){var d;a.status.isTimeout=!1;try{d=setTimeout(function(){a.status.isTimeout=!0;a.getRankingData(c)},a.settings.common.ajaxtimer);var e=a.props.ashiato.items[c];b.ajax({url:a.settings.reco.url,cache:!1,dataType:"jsonp",data:{item_id:e.shopid+"_"+e.itemid},scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(b){if(a.status.isTimeout)b=
!1;else if(clearTimeout(d),b.status===f||b.item_count===f||"Success"!=b.status&&"NotFound"!=b.status)b=!1;else{for(var e=[],j=0;j<b.item.length;j++)e.push({itemname:a.editItemname(b.item[j].item_name,a.settings.reco.omitname),itemurl:a.editItemurl(b.item[j].item_url,a.settings.reco.sid),imageele:"",imageurl:a.editImageurl(b.item[j].image_url_80,a.settings.reco.imagesize),imagealt:a.editItemname(b.item[j].item_name,a.settings.reco.omitname),imagetitle:a.editItemname(b.item[j].item_name,a.settings.reco.omitname),
itemprice:a.editItemprice(b.item[j].item_price)});a.props.reco.items[c]=e;b=b.item_count<a.settings.common.recothreshold?!1:a.displayRecoData(c)}b||a.getRankingData(c)},error:function(){a.getRankingData(c)}})}catch(i){return a.getRankingData(c),!1}return!0}clearInterval(a.props.checkWaitInterval);a.props.checkWaitInterval=setInterval(function(){a.props.requestPermission&&(clearInterval(a.props.checkWaitInterval),a.getRecoData(c))},a.settings.common.checkinterval)},getRankingData:function(c){function d(c,
d){if(a.status.isTimeout)return!1;clearTimeout(e);if(c.status===f||c.num===f||"Success"!=c.status&&"GenreNotFound"!=c.status)return!1;if(c.num<a.settings.common.recothreshold)return a.regImpressionCode(a.settings.common.impnodisp),!1;for(var i=a.props.ashiato.items[d],k=[],g=0;g<c.items.length;g++){var h=(/R2=([^\&]+)/.exec(c.items[g].itemurl)||[])[1],l=!0;if(h===f&&/^http:\/\/item.rakuten.co.jp/.test(c.items[g].itemurl))l=!1,h=c.items[g].itemurl;h!==f&&(a.endsWith(h,i.shopurl+"/"+i.mngnumber+"/")||
k.push({itemname:a.editItemname(c.items[g].itemname,a.settings.reco.omitname),itemurl:a.editItemurl(c.items[g].itemurl,a.settings.ranking.sid,l),imageele:"",imageurl:a.editImageurl(c.items[g].imageurl64,a.settings.reco.imagesize),imagealt:a.editItemname(c.items[g].itemname,a.settings.reco.omitname),imagetitle:a.editItemname(c.items[g].itemname,a.settings.reco.omitname),itemprice:a.editItemprice(c.items[g].price)}))}if(k.length<a.settings.common.recothreshold)return a.regImpressionCode(a.settings.common.impnodisp),
!1;1===a.settings.common.rankingshuffle&&(k=a.shuffle(k));a.props.reco.items[d]==f&&(a.props.reco.items[d]=[]);a.props.reco.items[d]=b.merge(a.props.reco.items[d],k);return a.displayRecoData(d)}var e;a.status.isTimeout=!1;try{e=setTimeout(function(){a.status.isTimeout=!0;a.props.initialized?a.displayRecoDefaultContents():a.displayDefaultContents()},a.settings.common.ajaxtimer);var i=a.props.ashiato.items[c].genreidlist.replace(/^\//,"").split("/"),i=i[a.settings.ranking.genrelayer];i===f&&(i=0);b.ajax({url:a.settings.ranking.url,
cache:!0,dataType:"jsonp",data:{gid:i},jsonpCallback:"jsonp0123456789012",scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(b){d(b,c)||(a.props.initialized?a.displayRecoDefaultContents():a.displayDefaultContents())},error:function(){a.props.initialized?a.displayRecoDefaultContents():a.displayDefaultContents()}})}catch(h){return a.props.initialized?a.displayRecoDefaultContents():a.displayDefaultContents(),!1}return!0},displayRecoData:function(c){if(0===a.eobj.reco.proto.length)return!1;
a.props.reco.proto.width=a.eobj.reco.proto.outerWidth();a.props.reco.proto.height=a.eobj.reco.proto.outerHeight();a.props.reco.proto.html=a.eobj.reco.proto.html();if(""==a.props.reco.proto.html)return!1;a.eobj.reco.proto.hide();a.eobj.reco.itemsDisplay.empty();a.eobj.reco.prevButton.find("a").unbind("click");a.eobj.reco.nextButton.find("a").unbind("click");a.eobj.reco.altContents.hide();a.eobj.common.loading.hide();a.eobj.common.recoSlider.show();a.regImpressionCode(a.settings.common.impdisp);a.eobj.reco.itemsDisplay.RJS_Slideshow(a,
{settings:a.settings.reco,itemPrototype:a.props.reco.proto,eobj:a.eobj.reco,items:a.props.reco.items[c],events:{beforeFirstRender:function(a,c){c.props.initialized=!0;c.eobj.reco.itemsDisplay.show()},afterFirstRender:function(a,c){c.props.requestPermission=!1;c.props.requestPermissionTimer=setTimeout(function(){c.props.requestPermission=!0},c.settings.common.requestwait)}}});return!0},regImpressionCode:function(c){return h[a.settings.common.impvar]===f||""==c?"":h[a.settings.common.impvar]=c},shuffle:function(a){for(var a=
Array.apply(null,a),b=a.length;b;){var e=Math.floor(Math.random()*b),f=a[--b];a[b]=a[e];a[e]=f}return a},endsWith:function(a,b){var e=a.length-b.length;return 0<=e&&a.lastIndexOf(b)===e},editItemname:function(a,d){a=b.RJS_Helpers.omitStr(a,d,"¡Ä");b.browser.msie||(a=a.split("").join(String.fromCharCode(8203)));return a},editItemprice:function(a){return""!=a&&a!==f?(""+a).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"):a},editImageurl:function(a,d){""!=a&&(a=b.RJS_Helpers.urlParameter(a,{_ex:d}));return a},
editItemurl:function(a,d,e){""!=d&&(a=e?b.RJS_Helpers.urlR2Parameter(a,{"s-id":d},!1):b.RJS_Helpers.urlParameter(a,{"s-id":d},!1));return a}})}).initialize()}})(this);
