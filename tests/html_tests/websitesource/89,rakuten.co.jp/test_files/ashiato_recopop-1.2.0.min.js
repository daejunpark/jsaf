/*
 ashiato_recopop-1.2.0.js
 Copyright (c) 2013 Rakuten.Inc
 Date : 2013-04-05 15:50:48
*/
(function(l,i){if(l.jQuery!==i){jQuery.noConflict();var d=jQuery;d.RJS_Helpers&&d().RJS_Slideshow&&(new function(){var a=this;d.extend(a,{settings:{noready:[0,"Int","^[0-1]$"],maxitem:[4,"Int","^[1-9]$"],minitem:[1,"Int","^[1-9]$"],pagespeed:[100,"Range","0,9999"],opacityspeed:[100,"Range","0,9999"],omitname:[38,"Range","0,100"],maxitem:[4,"Int","^[1-9]$"],autoslidetime:[2,"Range","1,99"],autoslideflag:["next","Str","^(next|prev)$"],autoslide:[0,"Int","^[0-1]$"],autoresize:[0,"Int","^[0-1]$"],impvar:["",
"Str","^[a-zA-Z0-9_]{3,64}$"],impdisp:["","Str","^[a-zA-Z0-9_]{3,64}$"],impnodisp:["","Str","^[a-zA-Z0-9_]{3,64}$"],verticalmode:[0,"Int","^[1]$"],ashiato_url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],ashiato_sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"],ashiato_imgsize:["80x80","Str","^[1-9]{1}[0-9]{1,2}x[1-9]{1}[0-9]{1,2}"],recopop_imgsize:["64x64","Str","^[1-9]{1}[0-9]{1,2}x[1-9]{1}[0-9]{1,2}"],recommend_url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],
recommend_sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"],ranking_url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],ranking_sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"],ranking_genrelayer:[1,"Int","^[1-5]$"],ajaxtimer:[3,"Range","1,99"],recothreshold:[6,"Int","^[1-9].*$"],rankingshuffle:[1,"Int","^[0-1]$"],requestwait:[500,"Range","0,9999"],itempricedisp:[1,"Int","^[0-1]$"],tailimagesize:[0,"Range","0,9999"],recopopwidth:[0,"Range","0,9999"],doublecolumn:[0,
"Int","^[0-1]$"],recopopmaxitem:[6,"Range","1,7"],indicator:[0,"Int","^[0-1]$"],indicatoralign:[0,"Int","^[0-1]$"]},eobj:{config:d("#ashiatoConfig"),existItem:d("#ashiatoExistItemDisplay"),overMaxItem:d("#ashiatoOverMaxItemDisplay"),prototypeAshiatoItem:d("#prototypeAshiatoItem"),prototypeRecoPopItem:d("#prototypeRecoPopItem"),prototypeRecoPopFrame:d("#prototypeRecoPopFrame"),prevButton:d("#ashiatoPrevButton"),nextButton:d("#ashiatoNextButton"),loading:d("#ashiatoLoading"),altContents:d("#ashiatoAlteredContents"),
itemsDisplay:d("#ashiatoItemsDisplay"),indicatorDisplay:d("#ashiatoIndicatorArea"),prototypeIndicator:d("#prototypeAshiatoIndicator")},recoPop_eobj:{loading:null,itemsFrame:null,itemsDisplay:null,prevButton:null,nextButton:null,wrapper:null},status:{error:!1,isTimeout:!1},props:{ashiato:{items:[],itemEvents:{remove:"#prototypeAshiatoRemove"},itemPrototype:{html:"",height:0,width:0,identifiers:{itemurl:["",/\#ITEMURL\#/g,""],imageele:['<img src="#ITEMIMGURL#" alt="#ITEMIMGALT#" title="#ITEMIMGTITLE#">',
/\#ITEMIMGELE\#/g,""],imageurl:["",/\#ITEMIMGURL\#/g,""],imagealt:["",/\#ITEMIMGALT\#/g,""],imagetitle:["",/\#ITEMIMGTITLE\#/g,""],itemname:["",/\#ITEMNAME\#/g,""],itemprice:["",/\#ITEMPRICE\#/g,""],index:["",/\#INDEX\#/g,""]}}},recommend:{items:[],cachedObj:[],index:-1,itemPrototype:{html:"",identifiers:{itemimg1:['<img src="#ITEMIMGURL1#" alt="#ITEMIMGALT1#" title="#ITEMIMGTITLE1#">',/\#ITEMIMG1\#/g,""],itemurl1:["",/\#ITEMURL1\#/g,""],imageurl1:["",/\#ITEMIMGURL1\#/g,""],imagealt1:["",/\#ITEMIMGALT1\#/g,
""],imagetitle1:["",/\#ITEMIMGTITLE1\#/g,""],itemprice1:["",/\#ITEMPRICE1\#/g,""],itemimg2:['<img src="#ITEMIMGURL2#" alt="#ITEMIMGALT2#" title="#ITEMIMGTITLE2#">',/\#ITEMIMG2\#/g,""],itemurl2:["",/\#ITEMURL2\#/g,""],imageurl2:["",/\#ITEMIMGURL2\#/g,""],imagealt2:["",/\#ITEMIMGALT2\#/g,""],imagetitle2:["",/\#ITEMIMGTITLE2\#/g,""],itemprice2:["",/\#ITEMPRICE2\#/g,""]}}},indicatorPrototype:{html:"",width:0,hheight:0},delUrlIndex:"delurl",tailImgHalfSize:0,exclusive:!1,recoPopFocus:!1,recoPopTimer:null},
initialize:function(){a.loadSettings()?1===a.settings.noReady?a.begin():jQuery(document).ready(function(){a.begin()}):a.displayDefaultContents()},loadSettings:function(){a.settings=d.RJS_Helpers.readAttr(a.eobj.config,a.settings);if(""==a.settings.ashiato_url||512<a.settings.ashiato_url.length||""==a.settings.recommend_url||512<a.settings.recommend_url.length||""==a.settings.ranking_url||512<a.settings.ranking_url.length)return!1;a.settings.autoslidetime*=1E3;a.settings.ajaxtimer*=1E3;if(0===a.eobj.prototypeAshiatoItem.length||
0===a.eobj.prototypeRecoPopItem.length||0===a.eobj.prototypeRecoPopFrame.length)return!1;a.settings.tailimagesize=Math.floor(a.settings.tailimagesize/2);a.eobj.config.remove();return!0},begin:function(){a.getAshiatoData();a.status.error=!a.getAshiatoPrototype();a.status.error=!a.getRecoPopPrototype()},getAshiatoData:function(){function b(b){if(a.status.isTimeout)return!1;clearTimeout(c);if(b.code===i||b.num===i)return a.displayDefaultContents(),!1;if("1"==b.code||"8"==b.code)return a.displayDefaultContents(a.settings.impnodisp),
!1;if("0"!=b.code)return a.displayDefaultContents(),!1;if(1>b.items.length)return a.displayDefaultContents(a.settings.impnodisp),!1;for(var e=0;e<b.items.length;e++)a.props.ashiato.items.push({index:e,delurl:b.items[e].delurl,itemname:a.editItemname(b.items[e].itemname),itemprice:a.editItemprice(b.items[e].itemprice),itemurl:a.editItemurl(b.items[e].itemurlfull,a.settings.ashiato_sid),imageele:"",imageurl:""!=b.items[e].imageurl?a.editImageurl(b.items[e].imageurl,a.settings.ashiato_imgsize):b.items[e].imageurl64,
imagealt:a.editItemname(b.items[e].itemname),imagetitle:a.editItemname(b.items[e].itemname),mngnumber:b.items[e].mngnumber,shopurl:b.items[e].shopurl,itemid:b.items[e].itemid,shopid:b.items[e].shopid,genreidlist:b.items[e].genreidlist});if(a.status.error)return a.displayDefaultContents(),!1;a.startSlideshow();a.regImpressionCode(a.settings.impdisp);return!0}var c;a.status.isTimeout=!1;try{c=setTimeout(function(){a.status.isTimeout=!0;a.displayDefaultContents()},a.settings.ajaxtimer),d.ajax({url:a.settings.ashiato_url,
cache:!1,dataType:"jsonp",scriptCharset:"euc-jp",timeout:a.settings.ajaxtimer,success:function(a){b(a)},error:function(){a.displayDefaultContents();a.status.isTimeout=!0}})}catch(g){return a.displayDefaultContents(),!1}return!0},getAshiatoPrototype:function(){var b=a.eobj.prototypeAshiatoItem,c=a.props.ashiato.itemPrototype;if(0==b.length)return!1;1!==a.settings.itempricedisp&&b.find(".ashiatoPrice span").remove();c.width=b.outerWidth();c.height=b.outerHeight();c.html=b.html();if(""==c.html)return!1;
b.remove();if(1===a.settings.indicator){b=a.eobj.prototypeIndicator;c=a.props.indicatorPrototype;if(0==b.length)return!1;c.width=b.outerWidth();c.height=b.outerHeight();c.html=b.html();if(""==c.html)return!1}return!0},startSlideshow:function(){a.eobj.existItem.show();a.eobj.itemsDisplay.RJS_Slideshow(a,{settings:a.settings,itemPrototype:a.props.ashiato.itemPrototype,indicatorPrototype:a.props.indicatorPrototype,eobj:a.eobj,items:a.props.ashiato.items,itemEvents:a.props.ashiato.itemEvents,events:{onItemRemove:a.deleteItem,
afterRemove:a.afterRemove,onZeroItems:a.removeSlideShow,afterFirstRender:a.afterFirstRender,beforeFirstRender:a.beforeFirstRender,startSlide:a.startSlide,afterSlide:a.afterSlide,onResize:a.onResize}})},getRecommendData:function(b,c,g,k){var e;a.status.isTimeout=!1;try{e=setTimeout(function(){a.status.isTimeout=!0;a.getRankingData(b,c,g,k)},a.settings.ajaxtimer);var h=a.props.ashiato.items[b];d.ajax({url:a.settings.recommend_url,cache:!1,dataType:"jsonp",data:{item_id:h.shopid+"_"+h.itemid},scriptCharset:"euc-jp",
timeout:a.settings.ajaxtimer,success:function(d){if(a.status.isTimeout)d=!1;else if(clearTimeout(e),d.status===i||d.item_count===i||"Success"!=d.status&&"NotFound"!=d.status)d=!1;else{for(var f=[],h=0;h<d.item.length;h++)f.push({itemurl:a.editItemurl(d.item[h].item_url,a.settings.recommend_sid),itemprice:a.editItemprice(d.item[h].item_price),imageele:"",imageurl:a.editImageurl(d.item[h].small_image_url,a.settings.recopop_imgsize),imagealt:a.editItemname(d.item[h].item_name),imagetitle:a.editItemname(d.item[h].item_name)});
a.props.recommend.items[b]=f;d=d.item_count<a.settings.recothreshold*(1+parseInt(a.settings.doublecolumn))?!1:a.prepareRecoPopItems(b,c,g,k)}d||a.getRankingData(b,c,g,k)},error:function(){a.getRankingData(b,c,g,k)}})}catch(f){return a.getRankingData(b,c,g,k)}return!0},getRankingData:function(b,c,g,k){var e;a.status.isTimeout=!1;try{e=setTimeout(function(){a.status.isTimeout=!0;a.prepareRecoPopItems(b,c,g,k)},a.settings.ajaxtimer);var h=a.props.ashiato.items[b].genreidlist.replace(/^\//,"").split("/"),
h=h[a.settings.ranking_genrelayer];h===i&&(h=0);d.ajax({url:a.settings.ranking_url,cache:!0,dataType:"jsonp",data:{gid:h},jsonpCallback:"jsonp0123456789012",scriptCharset:"euc-jp",timeout:a.settings.ajaxtimer,success:function(f){if(!a.status.isTimeout&&(clearTimeout(e),!(f.status===i||f.num===i||"Success"!=f.status&&"GenreNotFound"!=f.status||0==f.num))){for(var h=a.props.ashiato.items[b],m=[],j=0;j<f.items.length;j++){var n=(/R2=([^\&]+)/.exec(f.items[j].itemurl)||[])[1],l=!0;if(n===i&&/^http:\/\/item.rakuten.co.jp/.test(f.items[j].itemurl))l=
!1,n=f.items[j].itemurl;n!==i&&(a.endsWith(n,h.shopurl+"/"+h.mngnumber+"/")||m.push({itemurl:a.editItemurl(f.items[j].itemurl,a.settings.ranking_sid,l),itemprice:a.editItemprice(f.items[j].price),imageele:"",imageurl:a.editImageurl(f.items[j].imageurl64),imagealt:a.editItemname(f.items[j].itemname),imagetitle:a.editItemname(f.items[j].itemname)}))}1===a.settings.rankingshuffle&&(m=a.shuffle(m));f=a.props.recommend.items[b];f==i&&(f=[]);f=d.merge(f,m);for(j=0;j<f.length;j++)if(""==f[j].itemurl||f[j].itemurl==
i||""==f[j].itemprice||f[j].itemprice==i)f.splice(j,1),j--;a.props.recommend.items[b]=f}a.prepareRecoPopItems(b,c,g,k)},error:function(){a.prepareRecoPopItems(b,c,g,k)}})}catch(f){a.prepareRecoPopItems(b,c,g,k)}},getRecoPopPrototype:function(){var b=a.eobj.prototypeRecoPopItem,c=a.props.recommend.itemPrototype;if(0==b.length)return!1;c.html=b.html();if(""==c.html)return!1;b.remove();return!0},prepareRecoPopItems:function(b,c,d,k){if(a.props.recommend.items[b]===i||0==a.props.recommend.items[b].length)return a.displayAlteredContents(b,
c,d);var e=a.props.recommend.items[b];if("0"==a.settings.doublecolumn){for(var h=[],f=0;f<e.length;f++)h.push({itemimg1:"",itemurl1:e[f].itemurl,imageurl1:e[f].imageurl,itemprice1:e[f].itemprice,imagealt1:e[f].imagealt,imagetitle1:e[f].imagetitle,itemimg2:i,itemurl2:i,imageurl2:i,itemprice2:i,imagealt2:i,imagetitle2:i});e=h}else if("1"==a.settings.doublecolumn){h=[];1==e.length%2&&e.splice(e.length-1,1);for(f=0;f<e.length;f++)h.push({itemimg1:"",itemurl1:e[f].itemurl,imageurl1:e[f].imageurl,itemprice1:e[f].itemprice,
imagealt1:e[f].imagealt,imagetitle1:e[f++].imagetitle,itemimg2:"",itemurl2:e[f].itemurl,imageurl2:e[f].imageurl,itemprice2:e[f].itemprice,imagealt2:e[f].imagealt,imagetitle2:e[f].imagetitle});e=h}if(0==e.length)return a.displayAlteredContents(b,c,d);a.props.recommend.items[b]=e;a.prepareRecoPopSlideshow(b,c,k);a.startRecoPopSlideshow(b);return!0},prepareRecoPopSlideshow:function(b,c,g){a.props.recommend.cachedObj[b]==i?(a.recoPop_eobj.loading=c,a.recoPop_eobj.itemsFrame=g,a.recoPop_eobj.itemsDisplay=
g.find(".recoPopItemsDisplay"),a.recoPop_eobj.prevButton=g.find(".recoPopPrevButton"),a.recoPop_eobj.nextButton=g.find(".recoPopNextButton"),a.props.recommend.cachedObj[b]=d.extend(!0,{},a.recoPop_eobj)):(b=d.extend(!0,{},a.props.recommend.cachedObj[b]),a.recoPop_eobj.loading=b.loading,a.recoPop_eobj.itemsDisplay=b.itemsDisplay,a.recoPop_eobj.prevButton=b.prevButton,a.recoPop_eobj.nextButton=b.nextButton)},startRecoPopSlideshow:function(b){if(!(a.props.recommend.items[b]===i||0==a.props.recommend.items[b].length)){var c=
a.settings.maxitem;a.settings.maxitem=a.settings.recopopmaxitem;a.recoPop_eobj.itemsDisplay.RJS_Slideshow(a,{settings:a.settings,itemPrototype:a.props.recommend.itemPrototype,eobj:a.recoPop_eobj,items:a.props.recommend.items[b],events:{beforeFirstRender:a.recoPop_beforeFirstRender}});a.settings.maxitem=c}},displayAlteredContents:function(a,c,d){c.hide();c.siblings(".recoPopPrevButton").hide();c.siblings(".recoPopNextButton").hide();d.show();return!0},initRecoPop:function(){var b=a.eobj.itemsDisplay.width(),
c=a.settings.recopopwidth;itemWidth=0;divide=0;offsetPopOrg=0;a.eobj.itemsDisplay.find(".riAshiatoContSpr").unbind("mouseenter").unbind("mouseleave").hover(function(){if(!a.props.exclusive){var b=d(this).attr("index"),c=d(this).find(".recoPopAlteredCnt"),e=d(this).find(".riAshiatoRecoPopList"),h=a.props.recommend.items[b];a.recoPop_eobj.wrapper=d(this).find(".riAshiatoRecoPopWrapper");c.hide();a.props.recommend.index=b;0==e.children().length&&e.append(a.eobj.prototypeRecoPopFrame.html());var f=d(this).find(".recoPopLoading");
h===i?(a.props.recoPopFocus=!0,a.props.recoPopTimer=setTimeout(function(){a.props.recoPopFocus&&(a.getRecommendData(b,f,c,e)?a.startRecoPopSlideshow(b):a.displayAlteredContents(b,f,c))},a.settings.requestwait)):0==h.length?(f.remove(),e.hide(),c.show()):(a.prepareRecoPopSlideshow(b,f,e),e.show());d(this).find(".riAshiatoRecoPopList").css({"margin-left":"auto","margin-right":"auto"});d(this).parent().css("position","");d(this).addClass("hover");d(this).find(".riAshiatoRecoPopFrame").fadeIn()}},function(){d(this).find(".riAshiatoRecoPopFrame").stop(!0,
!0).hide();d(this).removeClass("hover");d(this).parent().css("position","relative");d(this).find(".riAshiatoRecoPopList").hide();d(this).find(".recoPopLoading").show();clearTimeout(a.props.recoPopTimer);a.props.recoPopFocus=!1}).each(function(g){var i=d(this).find(".riAshiatoRecoPopFrame");0==g&&(itemWidth=d(this).parent().width(),divide=Math.floor(b/itemWidth)/2,offsetPopOrg=Math.floor((b-c)/2));var e=offsetPopOrg;0<g&&(e-=itemWidth*g);var h=i.find(".tail");g<divide?(g=Math.floor(offsetPopOrg*(divide-
(g+1))/divide),0<g&&(e-=g),e>itemWidth/4?(e=itemWidth/4,h.css("left","")):(g=itemWidth/2-e-a.settings.tailimagesize,h.css("left",g))):(g=Math.floor(offsetPopOrg*(g-divide)/divide),0<g&&(e+=g),e+c<3*itemWidth/4?(e+=3*itemWidth/4-(e+c),g=itemWidth/2+Math.abs(e)-a.settings.tailimagesize):g=itemWidth/2-e-a.settings.tailimagesize,h.css("left",g));i.css("left",e)})},regImpressionCode:function(b){return l[a.settings.impvar]===i||""==b?"":l[a.settings.impvar]=b},afterRemove:function(a){a.initRecoPop();a.props.exclusive=
!1},deleteItem:function(a,c){c.props.exclusive=!0;try{return(new Image).src=c.props.ashiato.items[a][c.props.delUrlIndex]+"&callback=?",!0}catch(d){return!1}},displayDefaultContents:function(b){a.eobj.loading.remove();a.eobj.altContents.show();a.eobj.existItem.remove();b&&a.regImpressionCode(b)},afterFirstRender:function(a,c){c.props.ashiato.items.length>a&&c.eobj.overMaxItem.show();c.initRecoPop()},beforeFirstRender:function(a,c){c.eobj.loading.remove();c.eobj.itemsDisplay.show()},startSlide:function(){a.props.exclusive=
!0},afterSlide:function(){a.initRecoPop();a.props.exclusive=!1},onResize:function(){a.initRecoPop()},removeSlideShow:function(a){a.eobj.existItem.css("visibility","hidden").slideUp("fast",function(){d(this).remove()})},recoPop_beforeFirstRender:function(a,c){c.recoPop_eobj.loading.remove();c.recoPop_eobj.itemsFrame.show()},shuffle:function(a){for(var a=Array.apply(null,a),c=a.length;c;){var d=Math.floor(Math.random()*c),i=a[--c];a[c]=a[d];a[d]=i}return a},endsWith:function(a,c){var d=a.length-c.length;
return 0<=d&&a.lastIndexOf(c)===d},editItemprice:function(a){return""!=a&&a!==i?(""+a).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"):a},editItemname:function(b){b=d.RJS_Helpers.omitStr(b,a.settings.omitname,"¡Ä");d.browser.msie||(b=b.split("").join(String.fromCharCode(8203)));return b},editImageurl:function(a,c){""!=a&&c!==i&&(a=d.RJS_Helpers.urlParameter(a,{_ex:c}));return a},editItemurl:function(a,c,g){""!=c&&(a=g?d.RJS_Helpers.urlR2Parameter(a,{"s-id":c},!1):d.RJS_Helpers.urlParameter(a,{"s-id":c},
!1));return a}})}).initialize()}})(this);
